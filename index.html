<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CopyCat Serverless</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
<script src="https://unpkg.com/feather-icons"></script>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
/* --- Styling --- */
:root {
  --font: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
  --bg: #000000;
  --card: #111111;
  --border: #2a2a2a;
  --text: #e5e7eb;
  --muted: #9ca3af;
  --accent: #0ea5e9;
  --accent-hover: #38bdf8;
  --success: #22c55e;
  --danger: #ef4444;
  --danger-hover: #f87171;
  --btn-secondary-bg: #333333;
  --btn-secondary-hover: #444444;
  --shadow-color: rgba(0, 0, 0, 0.7);
  --shadow-accent-glow: rgba(14, 165, 233, 0.3);
  --highlight-bg: rgba(14, 165, 233, 0.15);
  --transition-fast: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
}
*, *::before, *::after { box-sizing: border-box; }
html { font-size: 16px; scroll-behavior: smooth; }
body {
  margin: 0;
  background-color: var(--bg);
  color: var(--text);
  font-family: var(--font);
  padding: 24px;
}
.container {
  max-width: 980px;
  margin: auto;
  display: grid;
  gap: 24px;
}
.card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 16px;
  box-shadow: 0 10px 30px var(--shadow-color);
  overflow: hidden;
}
.card-header {
  padding: 16px 20px;
  border-bottom: 1px solid var(--border);
  font-weight: 600;
  font-size: 1.1rem;
  display: flex;
  align-items: center;
  gap: 10px;
}
.card-body { padding: 20px; }
.btn {
  border: none; padding: 10px 16px; border-radius: 10px; cursor: pointer; font-weight: 600;
  font-family: var(--font); display: inline-flex; align-items: center; justify-content: center;
  gap: 8px; transition: var(--transition-fast); box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}
.btn:hover { transform: translateY(-1px); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
.btn:active { transform: translateY(0); }
.btn:disabled { cursor: not-allowed; opacity: 0.6; }
.btn-primary { background: var(--accent); color: #fff; }
.btn-primary:hover:not(:disabled) { background: var(--accent-hover); }
.btn-secondary { background: var(--btn-secondary-bg); color: var(--text); }
.btn-secondary:hover:not(:disabled) { background: var(--btn-secondary-hover); }
.btn-danger { background: var(--danger); color: #fff; }
.btn-danger:hover:not(:disabled) { background: var(--danger-hover); }
.btn-sm { padding: 6px 10px; font-size: 0.875rem; border-radius: 8px; }
.form-control {
  background: #000000; border: 1px solid var(--border); padding: 10px 14px;
  border-radius: 10px; color: var(--text); width: 100%; font-family: var(--font);
  transition: var(--transition-fast);
}
.form-control:focus {
  outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px var(--shadow-accent-glow);
}
textarea.form-control {
  resize: vertical;
  min-height: 45px;
  line-height: 1.5;
}
#drop-zone {
  border: 2px dashed var(--border); padding: 32px; border-radius: 12px; text-align: center;
  color: var(--muted); transition: var(--transition-fast); cursor: pointer;
}
#drop-zone:hover { border-color: var(--accent); color: var(--accent); background: rgba(14, 165, 233, 0.05); }
#drop-zone.dragover {
  border-color: var(--accent); border-style: solid; color: var(--accent);
  background: rgba(14, 165, 233, 0.1); transform: scale(1.02);
}
.list-item {
  display: flex; justify-content: space-between; align-items: center; padding: 12px;
  border-radius: 10px; margin-bottom: 10px; border: 1px solid var(--border);
  transition: var(--transition-fast);
}
.list-item:hover { border-color: var(--accent); transform: translateY(-2px); }
.list-item.highlighted {
  border-color: var(--accent);
  box-shadow: 0 0 15px var(--shadow-accent-glow);
}
.file-list { list-style: none; padding: 0; margin: 0; }
.file-info { display: flex; align-items: center; gap: 12px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; max-width: 60%; }
.file-actions { display: flex; gap: 8px; align-items: center; }
#clipboard-list { max-height: 460px; overflow-y: auto; padding-right: 8px; }
.clipboard-item { align-items: flex-start; }
.clipboard-content { flex: 1; min-width: 0; }
.message-header { display: flex; flex-direction: column; align-items: flex-start; gap: 8px; margin-bottom: 8px; }
.message-title { font-weight: 600; font-size: 1.05rem; color: var(--text); }
.timestamp { color: var(--muted); font-size: 0.875rem; white-space: nowrap; }
.message-body { word-wrap: break-word; color: var(--text); line-height: 1.5; }
.message-body pre { margin: 0; white-space: pre-wrap; }
.message-body pre, .message-body code { font-family: monospace; font-size: 0.9rem; }
.clipboard-actions { display: flex; flex-direction: column; gap: 8px; margin-left: 12px; align-items: flex-end; }
#toast-container { position: fixed; right: 24px; top: 24px; z-index: 9999; display: flex; flex-direction: column; gap: 12px; }
.toast {
  min-width: 250px; padding: 12px 16px; border-radius: 10px; color: #fff; background: rgba(20, 20, 20, 0.7);
  backdrop-filter: blur(5px); box-shadow: 0 10px 30px var(--shadow-color); display: flex;
  align-items: center; justify-content: space-between; border-left: 4px solid;
}
.toast.success { border-color: var(--success); }
.toast.error { border-color: var(--danger); }
</style>
</head>
<body>
<div class="container">
  <div class="card">
    <div class="card-header"><i data-feather="clipboard"></i> Shared Clipboard</div>
    <div class="card-body">
      <div id="clipboard-list" aria-live="polite"></div>
      <input id="clipboardTitleInput" class="form-control" placeholder="Optional Title..." style="margin-top:12px; margin-bottom: 8px;">
      <div style="display:flex;gap:8px;">
        <textarea id="clipboardInput" class="form-control" placeholder="Type text to share..." rows="3"></textarea>
        <button id="shareBtn" class="btn btn-primary" title="Share"><i data-feather="send"></i></button>
      </div>
      <div id="clipboard-status" style="margin-top:10px;color:var(--muted);font-size:.9rem"></div>
      <div style="margin-top: 16px; text-align: right; display: flex; justify-content: flex-end; gap: 8px;">
        <button id="nextMessageBtn" class="btn btn-secondary"><i data-feather="arrow-down"></i> Next Message</button>
        <button id="resetClipboardBtn" class="btn btn-danger"><i data-feather="trash-2"></i> Reset</button>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-header"><i data-feather="upload-cloud"></i> File Hub</div>
    <div class="card-body">
      <div id="drop-zone">
        <input id="file-input" type="file" multiple style="display:none">
        <i data-feather="upload" style="width:36px;height:36px"></i>
        <p style="color:var(--muted);margin:8px 0 0 0">Drag & drop, paste, or click to select files.</p>
      </div>
      <div style="margin-top: 16px; display: flex; gap: 8px;">
        <input id="url-input" class="form-control" placeholder="Or enter a file URL or data URL...">
        <button id="url-upload-btn" class="btn btn-primary">Upload</button>
      </div>
      <div id="upload-status" style="margin-top:10px;color:var(--accent);font-size:.9rem"></div>
    </div>
  </div>

  <div class="card">
    <div class="card-header"><i data-feather="hard-drive"></i> Available Files</div>
    <div class="card-body">
      <ul id="fileList" class="file-list"></ul>
      <div style="margin-top:16px;text-align:right">
        <button id="resetFilesBtn" class="btn btn-danger"><i data-feather="trash-2"></i> Reset All Files</button>
      </div>
    </div>
  </div>
</div>

<div id="toast-container" aria-live="polite" aria-atomic="true"></div>

<script>
    // --- DOM Elements ---
    const clipboardInput = document.getElementById('clipboardInput');
    const shareBtn = document.getElementById('shareBtn');
    const clipboardList = document.getElementById('clipboard-list');
    const resetClipboardBtn = document.getElementById('resetClipboardBtn');
    const clipboardStatus = document.getElementById('clipboard-status');
    const clipboardTitleInput = document.getElementById('clipboardTitleInput');
    const nextMessageBtn = document.getElementById('nextMessageBtn');
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('file-input');
    const fileList = document.getElementById('fileList');
    const resetFilesBtn = document.getElementById('resetFilesBtn');
    const uploadStatus = document.getElementById('upload-status');
    const urlInput = document.getElementById('url-input');
    const urlUploadBtn = document.getElementById('url-upload-btn');
    
    let supabase;
    let currentMessageIndex = -1;

    // --- UTILITY FUNCTIONS ---
    function showToast(message, isError = false) {
        const container = document.getElementById('toast-container');
        const div = document.createElement('div');
        div.className = 'toast ' + (isError ? 'error' : 'success');
        div.textContent = message;
        container.appendChild(div);
        setTimeout(() => {
            div.style.transition = 'opacity 0.28s';
            div.style.opacity = '0';
            setTimeout(() => div.remove(), 3200);
        }, 2200);
    }

    function escapeHTML(str) {
      if (!str) return '';
      return str.toString().replace(/[&<>"']/g, function(match) {
        return {
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#039;'
        }[match];
      });
    }

    function setUploadStatus(msg, isErr = false) {
        uploadStatus.textContent = msg;
        uploadStatus.style.color = isErr ? 'var(--danger)' : 'var(--accent)';
        setTimeout(() => { if (uploadStatus.textContent === msg) uploadStatus.textContent = ''; }, 3000);
    }
    
    function copyText(text) {
        if (!navigator.clipboard) return;
        navigator.clipboard.writeText(text).then(() => {
            showToast('Copied to clipboard!');
        }).catch(err => console.error('Copy failed', err));
    }

    function formatTimestamp(dateString) {
        const date = new Date(dateString);
        return date.toLocaleString('en-US', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit', hour12: true });
    }
    
    function dataURLtoFile(dataurl, filename) {
        var arr = dataurl.split(','), mime = arr[0].match(/:(.*?);/)[1],
            bstr = atob(arr[1]), n = bstr.length, u8arr = new Uint8Array(n);
        while(n--){
            u8arr[n] = bstr.charCodeAt(n);
        }
        return new File([u8arr], filename, {type:mime});
    }

    function getExtensionFromMimeType(mimeType) {
        const mimeMap = {
            'image/jpeg': '.jpg', 'image/png': '.png', 'image/gif': '.gif', 'image/webp': '.webp',
            'application/pdf': '.pdf', 'text/plain': '.txt', 'text/html': '.html',
        };
        return mimeMap[mimeType] || '';
    }
    
    // --- CLIPBOARD FEATURE ---
    async function fetchMessages() {
        const { data, error } = await supabase.from('messages').select('*').order('created_at', { ascending: false }).limit(100);
        if (error) { console.error('Error fetching messages:', error); return; }
        
        currentMessageIndex = -1;
        clipboardList.innerHTML = ''; 

        data.forEach(msg => {
            const listItem = document.createElement('div');
            listItem.className = 'list-item clipboard-item';
            const titleHTML = msg.title ? `<div class="message-title">${escapeHTML(msg.title)}</div>` : '';
            listItem.innerHTML = `
                <div class="clipboard-content">
                    <div class="message-header">${titleHTML}<div class="timestamp">${formatTimestamp(msg.created_at)}</div></div>
                    <div class="message-body"><pre><code></code></pre></div>
                </div>
                <div class="clipboard-actions"></div>`;
            listItem.querySelector('.message-body code').textContent = msg.content;
            
            const actionsDiv = listItem.querySelector('.clipboard-actions');
            const copyBtn = document.createElement('button');
            copyBtn.className = 'btn btn-secondary btn-sm'; copyBtn.title = 'Copy';
            copyBtn.innerHTML = `<i data-feather="copy"></i>`; copyBtn.onclick = () => copyText(msg.content);
            
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'btn btn-danger btn-sm'; deleteBtn.title = 'Delete';
            deleteBtn.innerHTML = `<i data-feather="trash-2"></i>`; deleteBtn.onclick = () => deleteMessage(msg.id);

            actionsDiv.appendChild(copyBtn); actionsDiv.appendChild(deleteBtn);
            clipboardList.appendChild(listItem);
        });

        feather.replace();
    }

    async function shareMessage() {
        const content = clipboardInput.value;
        const title = clipboardTitleInput.value.trim();
        
        if (content) {
            clipboardInput.disabled = true; clipboardTitleInput.disabled = true; shareBtn.disabled = true;
            const messageData = { content };
            if (title) messageData.title = title;

            const { error } = await supabase.from('messages').insert(messageData);
            
            if (error) { showToast('Failed to share message.', true); console.error('Share error:', error); } 
            else { clipboardInput.value = ''; clipboardTitleInput.value = ''; }
            clipboardInput.disabled = false; clipboardTitleInput.disabled = false; shareBtn.disabled = false;
            clipboardInput.focus();
        }
    }

    async function deleteMessage(id) {
        const { error } = await supabase.from('messages').delete().eq('id', id);
        if (error) showToast('Failed to delete message.', true);
        else showToast('Message deleted.');
    }
    
    async function resetClipboard() {
        const { error } = await supabase.from('messages').delete().neq('id', 0);
        if (error) showToast('Failed to reset clipboard.', true);
        else showToast('Clipboard cleared.');
    }

    function selectNextMessage() {
        const messages = clipboardList.querySelectorAll('.list-item');
        if (messages.length === 0) return;
        if (currentMessageIndex > -1) messages[currentMessageIndex].classList.remove('highlighted');
        currentMessageIndex = (currentMessageIndex + 1) % messages.length;
        const currentMessage = messages[currentMessageIndex];
        currentMessage.classList.add('highlighted');
        currentMessage.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    // --- FILE HUB FEATURE ---
    async function fetchFiles() {
        const { data, error } = await supabase.storage.from('files').list('', { sortBy: { column: 'created_at', order: 'desc' } });
        if (error) { console.error('Error listing files:', error); return; }

        fileList.innerHTML = ''; 

        data.forEach(file => {
            const listItem = document.createElement('li');
            listItem.className = 'list-item';
            const fileUrl = supabase.storage.from('files').getPublicUrl(file.name).data.publicUrl;
            listItem.innerHTML = `
                <div class="file-info"><i data-feather="file-text"></i><span></span></div>
                <div class="file-actions">
                    <a class="btn btn-primary btn-sm" href="${fileUrl}" title="Download"><i data-feather="download"></i></a>
                    <a class="btn btn-secondary btn-sm" href="${fileUrl}" target="_blank" title="View"><i data-feather="eye"></i></a>
                </div>`;
            listItem.querySelector('.file-info span').textContent = file.name;
            listItem.querySelector('a[title="Download"]').setAttribute('download', file.name);

            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'btn btn-danger btn-sm'; deleteBtn.title = 'Delete';
            deleteBtn.innerHTML = `<i data-feather="trash-2"></i>`; deleteBtn.onclick = () => deleteFile(file.name);
            listItem.querySelector('.file-actions').appendChild(deleteBtn);
            fileList.appendChild(listItem);
        });

        feather.replace();
    }

    async function uploadFile(file) {
        setUploadStatus(`Uploading ${file.name}...`);
        const { error } = await supabase.storage.from('files').upload(file.name, file, { upsert: true });
        if (error) { setUploadStatus(`Failed to upload ${file.name}.`, true); console.error('Upload error:', error); } 
        else { setUploadStatus(`Uploaded ${file.name} successfully!`); }
    }
    
    // UPDATED: More robust URL fetching
    async function uploadFileFromUrl() {
        let url = urlInput.value.trim();
        if (!url) return;

        if (url.includes("drive.google.com")) {
            const match = url.match(/file\/d\/(.+?)\//);
            if (match && match[1]) url = `https://drive.google.com/uc?export=download&id=${match[1]}`;
        }
        
        if (url.startsWith('data:')) {
            try {
                const file = dataURLtoFile(url, `pasted-file-${Date.now()}`);
                await uploadFile(file); urlInput.value = '';
            } catch (error) { setUploadStatus('Failed to upload from data URL.', true); console.error('Data URL Error:', error); }
            return;
        }

        setUploadStatus('Fetching file from URL...');
        try {
            const response = await fetch(`https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

            const blob = await response.blob();
            const mimeType = blob.type;
            
            if (mimeType === 'text/html') {
                 const text = await blob.text();
                 const doc = new DOMParser().parseFromString(text, 'text/html');
                 const img = doc.querySelector('meta[property="og:image"]');
                 if (img && img.content) {
                     urlInput.value = img.content;
                     uploadFileFromUrl(); return;
                 } else { throw new Error('No direct image found on the page.'); }
            }

            const extension = getExtensionFromMimeType(mimeType);
            let fileName = url.substring(url.lastIndexOf('/') + 1).split('?')[0] || `file-${Date.now()}${extension}`;
            if (fileName && !fileName.includes('.')) fileName += extension;
            
            const file = new File([blob], fileName, { type: mimeType });
            await uploadFile(file);
            urlInput.value = '';

        } catch (error) {
            setUploadStatus(`Failed to fetch from URL. ${error.message}`, true);
            console.error('URL Fetch Error:', error);
        }
    }

    async function deleteFile(fileName) {
        const { error } = await supabase.storage.from('files').remove([fileName]);
        if (error) showToast(`Failed to delete ${fileName}.`, true);
        else showToast(`Deleted ${fileName}.`);
    }

    async function resetFiles() {
        const { data: files, error } = await supabase.storage.from('files').list();
        if (error) { showToast('Could not list files to delete.', true); return; }
        if (files.length === 0) { showToast('No files to delete.'); return; }
        const fileNames = files.map(f => f.name);
        const { error: deleteError } = await supabase.storage.from('files').remove(fileNames);
        if (deleteError) showToast('Failed to delete all files.', true);
        else showToast('All files have been deleted.');
    }

    // --- INITIALIZATION ---
    async function initializeApp() {
        try {
            const response = await fetch('/api/config');
            if (!response.ok) throw new Error('Network response was not ok');
            const config = await response.json();

            if (!config.url || !config.key) throw new Error('Supabase URL or Key is missing from config.');

            supabase = window.supabase.createClient(config.url, config.key);
            
            await fetchMessages();
            await fetchFiles();
            feather.replace();

            // --- Event Listeners ---
            shareBtn.addEventListener('click', shareMessage);
            clipboardInput.addEventListener('keypress', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); shareMessage(); } });
            resetClipboardBtn.addEventListener('click', resetClipboard);
            nextMessageBtn.addEventListener('click', selectNextMessage);

            dropZone.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', async (e) => { if (e.target.files.length > 0) { await Promise.all([...e.target.files].map(uploadFile)); fileInput.value = ''; } });
            dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
            dropZone.addEventListener('dragleave', () => { dropZone.classList.remove('dragover'); });
            dropZone.addEventListener('drop', async (e) => { e.preventDefault(); dropZone.classList.remove('dragover'); if (e.dataTransfer.files.length > 0) { await Promise.all([...e.dataTransfer.files].map(uploadFile)); } });
            
            dropZone.addEventListener('paste', async (e) => {
                e.preventDefault();
                if (e.clipboardData.files.length > 0) { await Promise.all([...e.clipboardData.files].map(uploadFile)); } 
                else { const pastedText = (e.clipboardData || window.clipboardData).getData('text'); if (pastedText) { urlInput.value = pastedText; showToast('URL pasted. Click Upload to proceed.'); } }
            });

            urlInput.addEventListener('paste', (e) => { e.preventDefault(); const pastedText = (e.clipboardData || window.clipboardData).getData('text'); urlInput.value = pastedText; });
            urlUploadBtn.addEventListener('click', uploadFileFromUrl);
            resetFilesBtn.addEventListener('click', resetFiles);
            
            // --- Realtime Subscriptions ---
            supabase.channel('public:messages')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'messages' }, (payload) => { console.log('Message change received!', payload); fetchMessages(); })
                .subscribe((status) => { if (status === 'SUBSCRIBED') console.log('Connected to realtime channel!'); });

            setInterval(fetchFiles, 5000);

        } catch (error) {
            console.error('Failed to initialize the application:', error);
            document.body.innerHTML = '<h1 style="color:red; text-align:center; margin-top: 50px;">Application failed to load. Check console for errors.</h1>';
        }
    }

    document.addEventListener('DOMContentLoaded', initializeApp);
</script>
</body>
</html>
