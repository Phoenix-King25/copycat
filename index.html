<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CopyCat Serverless</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
<script src="https://unpkg.com/feather-icons"></script>
<script src="./supabase.js"></script>

<style>
/* --- Black Theme & UI Refresh (Same as your original code) --- */
:root {
  --font: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
  --bg: #000000;
  --card: #111111;
  --border: #2a2a2a;
  --text: #e5e7eb;
  --muted: #9ca3af;
  --accent: #0ea5e9;
  --accent-hover: #38bdf8;
  --success: #22c55e;
  --danger: #ef4444;
  --danger-hover: #f87171;
  --btn-secondary-bg: #333333;
  --btn-secondary-hover: #444444;
  --shadow-color: rgba(0, 0, 0, 0.7);
  --shadow-accent-glow: rgba(14, 165, 233, 0.3);
  --highlight-bg: rgba(14, 165, 233, 0.15);
  --transition-fast: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
}
*, *::before, *::after { box-sizing: border-box; }
html { font-size: 16px; scroll-behavior: smooth; }
body {
  margin: 0;
  background-color: var(--bg);
  color: var(--text);
  font-family: var(--font);
  padding: 24px;
}
.container {
  max-width: 980px;
  margin: auto;
  display: grid;
  gap: 24px;
}
.card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 16px;
  box-shadow: 0 10px 30px var(--shadow-color);
  overflow: hidden;
}
.card-header {
  padding: 16px 20px;
  border-bottom: 1px solid var(--border);
  font-weight: 600;
  font-size: 1.1rem;
  display: flex;
  align-items: center;
  gap: 10px;
}
.card-body { padding: 20px; }
.btn {
  border: none; padding: 10px 16px; border-radius: 10px; cursor: pointer; font-weight: 600;
  font-family: var(--font); display: inline-flex; align-items: center; justify-content: center;
  gap: 8px; transition: var(--transition-fast); box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}
.btn:hover { transform: translateY(-1px); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
.btn:active { transform: translateY(0); }
.btn:disabled { cursor: not-allowed; opacity: 0.6; }
.btn-primary { background: var(--accent); color: #fff; }
.btn-primary:hover:not(:disabled) { background: var(--accent-hover); }
.btn-secondary { background: var(--btn-secondary-bg); color: var(--text); }
.btn-secondary:hover:not(:disabled) { background: var(--btn-secondary-hover); }
.btn-danger { background: var(--danger); color: #fff; }
.btn-danger:hover:not(:disabled) { background: var(--danger-hover); }
.btn-sm { padding: 6px 10px; font-size: 0.875rem; border-radius: 8px; }
.form-control {
  background: #000000; border: 1px solid var(--border); padding: 10px 14px;
  border-radius: 10px; color: var(--text); width: 100%; font-family: var(--font);
  transition: var(--transition-fast);
}
.form-control:focus {
  outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px var(--shadow-accent-glow);
}
#drop-zone {
  border: 2px dashed var(--border); padding: 32px; border-radius: 12px; text-align: center;
  color: var(--muted); transition: var(--transition-fast); cursor: pointer;
}
#drop-zone:hover { border-color: var(--accent); color: var(--accent); background: rgba(14, 165, 233, 0.05); }
#drop-zone.dragover {
  border-color: var(--accent); border-style: solid; color: var(--accent);
  background: rgba(14, 165, 233, 0.1); transform: scale(1.02);
}
.list-item {
  display: flex; justify-content: space-between; align-items: center; padding: 12px;
  border-radius: 10px; margin-bottom: 10px; border: 1px solid var(--border);
  transition: var(--transition-fast);
}
.list-item:hover { border-color: var(--accent); transform: translateY(-2px); }
.file-list { list-style: none; padding: 0; margin: 0; }
.file-info { display: flex; align-items: center; gap: 12px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; max-width: 60%; }
.file-actions { display: flex; gap: 8px; align-items: center; }
#clipboard-list { max-height: 460px; overflow-y: auto; padding-right: 8px; }
.clipboard-item { align-items: flex-start; }
.clipboard-content { flex: 1; min-width: 0; }
.message-header { display: flex; align-items: center; gap: 12px; margin-bottom: 8px; }
.timestamp { color: var(--muted); font-size: 0.875rem; white-space: nowrap; }
.message-body { white-space: pre-wrap; word-wrap: break-word; color: var(--text); line-height: 1.5; }
.clipboard-actions { display: flex; flex-direction: column; gap: 8px; margin-left: 12px; align-items: flex-end; }
#toast-container { position: fixed; right: 24px; top: 24px; z-index: 9999; display: flex; flex-direction: column; gap: 12px; }
.toast {
  min-width: 250px; padding: 12px 16px; border-radius: 10px; color: #fff; background: rgba(20, 20, 20, 0.7);
  backdrop-filter: blur(5px); box-shadow: 0 10px 30px var(--shadow-color); display: flex;
  align-items: center; justify-content: space-between; border-left: 4px solid;
}
.toast.success { border-color: var(--success); }
.toast.error { border-color: var(--danger); }
</style>
</head>
<body>
<div class="container">
  <div class="card">
    <div class="card-header"><i data-feather="clipboard"></i> Shared Clipboard</div>
    <div class="card-body">
      <div id="clipboard-list" aria-live="polite"></div>
      <div style="display:flex;gap:8px;margin-top:12px">
        <input id="clipboardInput" class="form-control" placeholder="Type text to share...">
        <button id="shareBtn" class="btn btn-primary" title="Share"><i data-feather="send"></i></button>
      </div>
      <div id="clipboard-status" style="margin-top:10px;color:var(--muted);font-size:.9rem"></div>
      <div style="margin-top: 16px; text-align: right;">
        <button id="resetClipboardBtn" class="btn btn-danger"><i data-feather="trash-2"></i> Reset</button>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-header"><i data-feather="upload-cloud"></i> File Hub</div>
    <div class="card-body">
      <div id="drop-zone" onclick="document.getElementById('file-input').click()">
        <input id="file-input" type="file" multiple style="display:none">
        <i data-feather="upload" style="width:36px;height:36px"></i>
        <p style="color:var(--muted);margin:8px 0 0 0">Drag & drop files here, or click to select.</p>
      </div>
      <div id="upload-status" style="margin-top:10px;color:var(--accent);font-size:.9rem"></div>
    </div>
  </div>

  <div class="card">
    <div class="card-header"><i data-feather="hard-drive"></i> Available Files</div>
    <div class="card-body">
      <ul id="fileList" class="file-list"></ul>
      <div style="margin-top:16px;text-align:right">
        <button id="resetFilesBtn" class="btn btn-danger"><i data-feather="trash-2"></i> Reset All Files</button>
      </div>
    </div>
  </div>
</div>

<div id="toast-container" aria-live="polite" aria-atomic="true"></div>

<script>
    // --- DOM Elements ---
    const clipboardInput = document.getElementById('clipboardInput');
    const shareBtn = document.getElementById('shareBtn');
    const clipboardList = document.getElementById('clipboard-list');
    const resetClipboardBtn = document.getElementById('resetClipboardBtn');
    const clipboardStatus = document.getElementById('clipboard-status');

    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('file-input');
    const fileList = document.getElementById('fileList');
    const resetFilesBtn = document.getElementById('resetFilesBtn');
    const uploadStatus = document.getElementById('upload-status');
    
    // This will be initialized after fetching the config
    let supabase;

    // --- UTILITY FUNCTIONS ---
    function showToast(message, isError = false) {
        const container = document.getElementById('toast-container');
        const div = document.createElement('div');
        div.className = 'toast ' + (isError ? 'error' : 'success');
        div.textContent = message;
        container.appendChild(div);
        setTimeout(() => {
            div.style.transition = 'opacity 0.28s';
            div.style.opacity = '0';
            setTimeout(() => div.remove(), 320);
        }, 2200);
    }

    function setUploadStatus(msg, isErr = false) {
        uploadStatus.textContent = msg;
        uploadStatus.style.color = isErr ? 'var(--danger)' : 'var(--accent)';
        setTimeout(() => { if (uploadStatus.textContent === msg) uploadStatus.textContent = ''; }, 3000);
    }
    
    function copyText(text) {
        if (!navigator.clipboard) return;
        navigator.clipboard.writeText(text).then(() => {
            showToast('Copied to clipboard!');
        }).catch(err => console.error('Copy failed', err));
    }

    function formatTimestamp(dateString) {
        const date = new Date(dateString);
        return date.toLocaleString('en-US', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit', hour12: true });
    }

    // --- CLIPBOARD FEATURE ---
    async function fetchMessages() {
        const { data, error } = await supabase.from('messages').select('*').order('created_at', { ascending: false }).limit(100);
        if (error) {
            console.error('Error fetching messages:', error);
            return;
        }
        clipboardList.innerHTML = data.map(msg => `
            <div class="list-item clipboard-item">
                <div class="clipboard-content">
                    <div class="message-header">
                        <div class="timestamp">${formatTimestamp(msg.created_at)}</div>
                    </div>
                    <div class="message-body">${msg.content}</div>
                </div>
                <div class="clipboard-actions">
                    <button class="btn btn-secondary btn-sm" onclick='copyText(\`${msg.content.replace(/`/g, '\\`')}\`)' title="Copy"><i data-feather="copy"></i></button>
                    <button class="btn btn-danger btn-sm" onclick="deleteMessage(${msg.id})" title="Delete"><i data-feather="trash-2"></i></button>
                </div>
            </div>
        `).join('');
        feather.replace();
    }

    async function shareMessage() {
        const content = clipboardInput.value.trim();
        if (content) {
            clipboardInput.disabled = true;
            shareBtn.disabled = true;
            const { error } = await supabase.from('messages').insert({ content });
            if (error) {
                showToast('Failed to share message.', true);
                console.error('Share error:', error);
            } else {
                clipboardInput.value = '';
            }
            clipboardInput.disabled = false;
            shareBtn.disabled = false;
            clipboardInput.focus();
        }
    }

    async function deleteMessage(id) {
        const { error } = await supabase.from('messages').delete().eq('id', id);
        if (error) showToast('Failed to delete message.', true);
        else showToast('Message deleted.');
    }
    
    async function resetClipboard() {
        if (!confirm('Are you sure you want to delete all clipboard messages?')) return;
        const { data, error } = await supabase.from('messages').delete().neq('id', 0);
        if (error) showToast('Failed to reset clipboard.', true);
        else showToast('Clipboard cleared.');
    }

    // --- FILE HUB FEATURE ---
    async function fetchFiles() {
        const { data, error } = await supabase.storage.from('files').list('', { sortBy: { column: 'created_at', order: 'desc' } });
        if (error) {
            console.error('Error listing files:', error);
            return;
        }
        fileList.innerHTML = data.map(file => {
            const fileUrl = supabase.storage.from('files').getPublicUrl(file.name).data.publicUrl;
            return `
                <li class="list-item">
                    <div class="file-info">
                        <i data-feather="file-text"></i>
                        <span>${file.name}</span>
                    </div>
                    <div class="file-actions">
                        <a class="btn btn-primary btn-sm" href="${fileUrl}" download="${file.name}" title="Download"><i data-feather="download"></i></a>
                        <a class="btn btn-secondary btn-sm" href="${fileUrl}" target="_blank" title="View"><i data-feather="eye"></i></a>
                        <button class="btn btn-danger btn-sm" onclick="deleteFile('${file.name}')" title="Delete"><i data-feather="trash-2"></i></button>
                    </div>
                </li>`;
        }).join('');
        feather.replace();
    }

    async function uploadFile(file) {
        setUploadStatus(`Uploading ${file.name}...`);
        const { error } = await supabase.storage.from('files').upload(file.name, file, { upsert: true });
        if (error) {
            setUploadStatus(`Failed to upload ${file.name}.`, true);
            console.error('Upload error:', error);
        } else {
            setUploadStatus(`Uploaded ${file.name} successfully!`);
        }
    }

    async function deleteFile(fileName) {
        if (!confirm(`Are you sure you want to delete ${fileName}?`)) return;
        const { error } = await supabase.storage.from('files').remove([fileName]);
        if (error) showToast(`Failed to delete ${fileName}.`, true);
        else showToast(`Deleted ${fileName}.`);
    }

    async function resetFiles() {
        if (!confirm('Are you sure you want to delete ALL files? This cannot be undone.')) return;
        const { data: files, error } = await supabase.storage.from('files').list();
        if (error) {
            showToast('Could not list files to delete.', true);
            return;
        }
        if (files.length === 0) {
            showToast('No files to delete.');
            return;
        }
        const fileNames = files.map(file => file.name);
        const { error: deleteError } = await supabase.storage.from('files').remove(fileNames);
        if (deleteError) showToast('Failed to delete all files.', true);
        else showToast('All files have been deleted.');
    }

    // --- INITIALIZATION ---
    async function initializeApp() {
        try {
            // Step 1: Fetch the configuration from our serverless function
            const response = await fetch('/api/config');
            if (!response.ok) throw new Error('Network response was not ok');
            const config = await response.json();

            if (!config.url || !config.key) {
                throw new Error('Supabase URL or Key is missing from config.');
            }

            // Step 2: Initialize Supabase client
            // The global 'Supabase' object is loaded from the self-hosted supabase.js file
            supabase = Supabase.createClient(config.url, config.key);
            
            // Step 3: Now that Supabase is ready, load data and set up listeners
            await fetchMessages();
            await fetchFiles();
            feather.replace();

            // Clipboard Listeners
            shareBtn.addEventListener('click', shareMessage);
            clipboardInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') shareMessage();
            });
            resetClipboardBtn.addEventListener('click', resetClipboard);

            // File Listeners
            dropZone.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', async (e) => {
                if (e.target.files.length > 0) {
                    await Promise.all([...e.target.files].map(uploadFile));
                    fileInput.value = '';
                }
            });
            dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
            dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
            dropZone.addEventListener('drop', async (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
                if (e.dataTransfer.files.length > 0) {
                    await Promise.all([...e.dataTransfer.files].map(uploadFile));
                }
            });
            resetFilesBtn.addEventListener('click', resetFiles);
            
            // Realtime Subscriptions
            supabase.channel('public:messages')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'messages' }, (payload) => {
                    console.log('Message change received!', payload);
                    fetchMessages();
                })
                .subscribe();

            // Use a simple poll for storage as direct events are not available for public buckets
            setInterval(fetchFiles, 5000); // Poll for file changes every 5 seconds

        } catch (error) {
            console.error('Failed to initialize the application:', error);
            document.body.innerHTML = '<h1 style="color:red; text-align:center; margin-top: 50px;">Application failed to load. Check console for errors.</h1>';
        }
    }

    document.addEventListener('DOMContentLoaded', initializeApp);
</script>
</body>
</html>
